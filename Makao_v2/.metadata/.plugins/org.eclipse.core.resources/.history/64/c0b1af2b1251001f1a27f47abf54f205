package shared;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.OutputStream;
import java.net.Socket;



import tests.MessengerTest;



public class Messenger implements Runnable{
    private Socket socket = null;
	private PacketListener listener = null;
    private Thread listeningThread = null;
    private ObjectOutputStream output = null;
    private ObjectInputStream input = null;
    private BufferedInputStream binput = null;
	//private ArrayList<PacketListener>
    public Messenger(Socket socket) {
		// TODO Auto-generated constructor stub
		this.socket = socket;
		listeningThread = new Thread(this);
		listeningThread.start();
	}
    public void reinitializeOutputStream() throws IOException
    {
    	synchronized(this)
    	{
    		OutputStream os = socket.getOutputStream();
    		//BufferedOutputStream bos = new BufferedOutputStream(os);
    		output = new ObjectOutputStream(os);
    	}
    }
    public void closeOutput()
    {
    	
    }
    public void closeInput()
    {
    	
    }
    public void reinitializeInputStream() throws IOException
    {
    		InputStream is = socket.getInputStream();    		
    		//binput = new BufferedInputStream(is);
    		input = new ObjectInputStream(is);
    }

	public Socket getSocket() 
	{
		// TODO Auto-generated method stub
		return socket;
	}
	public void sendPakcet(Packet packet) throws IOException 
	{
		if (output==null) reinitializeOutputStream();
		output.writeObject(packet);		
	}

	public void addPacketListener(PacketListener plistener) 
	{
		synchronized(this)
		{
			listener = plistener;
		}
	}

	@Override
	public void run() {
		while(true)
		{
			System.out.println("working");
			synchronized(this)
			{
			if (listener==null) break;
			else 
			{
                if  (input==null)
                {
					try {
						reinitializeInputStream();
					} catch (IOException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
                }
			    Object obj=null;
				//try {	
				//	if (input.available() != 0)
					{
						System.out.println("before read");
						try {
							obj = input.readObject();
						} catch (IOException e) {
						// TODO Auto-generated catch block
							e.printStackTrace();
						} catch (ClassNotFoundException e) {
						// TODO Auto-generated catch block
							e.printStackTrace();
						}
						System.out.println("after read");
						if (obj instanceof Packet)
						{
							listener.packetReceived((Packet)obj);
						}
					}
			//	} catch (IOException e) {
					// TODO Auto-generated catch block
			//		e.printStackTrace();
			//	}
			}
			/*try {
				Thread.currentThread().sleep(100);
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}*/
			}
		}	
	}
    	
	
	
}
